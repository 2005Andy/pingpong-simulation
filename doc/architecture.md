# 乒乓球三维飞行仿真系统架构文档

## 项目概述

本项目是一个基于物理原理的乒乓球三维飞行轨迹仿真系统，实现了完整的乒乓球运动物理学模型，包括空气动力学、碰撞检测、球拍交互等。系统采用模块化设计，支持多场景仿真和详细的数据输出。

## 核心架构

### 模块化设计原则

项目采用严格的模块化架构，每个模块职责单一，便于维护、测试和扩展：

```
乒乓球仿真系统/
├── constants.py          # 物理常数和参数定义
├── ball_types.py         # 数据结构和类型定义
├── physics.py           # 物理计算引擎
├── simulation.py        # 仿真控制引擎
├── racket_control.py    # 球拍控制逻辑
├── scenarios.py         # 场景配置管理
├── visualization.py     # 数据可视化和输出
└── pingpong_main.py     # 命令行界面
```

### 模块详细说明

#### 1. constants.py - 物理常数定义

**功能**: 集中管理所有物理常数和系统参数
**关键常量**:

- **空气动力学参数**:
  - `AIR_DENSITY = 1.225` (kg/m³, 标准大气密度)
  - `GRAVITY = [0, 0, -9.81]` (m/s², 重力加速度)
  - `DRAG_COEFF = 0.40` (阻力系数)
  - `MAGNUS_COEFF = 0.20` (马格努斯效应系数)

- **球体参数 (ITTF标准)**:
  - `BALL_RADIUS = 0.020` (m, 球半径)
  - `BALL_MASS = 0.0027` (kg, 球质量)
  - `BALL_INERTIA_FACTOR = 2/3` (转动惯量因子)

- **球桌参数 (ITTF标准)**:
  - `TABLE_LENGTH = 2.74` (m, 球桌长度)
  - `TABLE_WIDTH = 1.525` (m, 球桌宽度)
  - `TABLE_HEIGHT = 0.76` (m, 球桌高度)
  - `NET_HEIGHT = 0.1525` (m, 球网高度)

- **球拍参数**:
  - `RACKET_RADIUS = 0.085` (m, 球拍半径)
  - 不同胶皮类型的物理属性 (反胶、生胶、防弧)

- **仿真参数**:
  - `TIME_STEP = 5e-5` (s, 时间步长)
  - `MAX_TIME = 10.0` (s, 最大仿真时间)

#### 2. ball_types.py - 数据结构定义

**核心数据类**:

- **BallState**: 球体状态 (位置、速度、角速度)
- **Table**: 球桌几何 (尺寸、材质属性)
- **Net**: 球网定义 (高度、长度)
- **RacketState**: 球拍状态 (位置、法向量、材质属性)
- **StrokeParams**: 击球参数 (目标位置、球拍角度、挥拍速度)
- **SimulationResult**: 仿真结果 (轨迹历史、事件日志)

**枚举类型**:
- **RubberType**: 胶皮类型 (INVERTED, PIMPLED, ANTISPIN)
- **EventType**: 事件类型 (TABLE_BOUNCE, RACKET_HIT, NET_COLLISION等)
- **Player**: 选手标识 (A, B)

#### 3. physics.py - 物理计算引擎

**空气动力学模型**:
```python
def aerodynamic_acceleration(velocity, omega):
    # 阻力: F_drag = -0.5 * ρ * v² * S * C_d * v̂
    # 马格努斯力: F_magnus = ρ * R³ * C_Ω * (ω × v)
    return gravity + drag + magnus_force
```

**碰撞检测系统**:
- **平面碰撞**: 球桌碰撞，使用脉冲-动量法
- **圆形球拍碰撞**: 球拍与球的交互
- **球网检测**: 轨迹穿越检测

**数值积分**:
- **RK4方法**: 四阶龙格-库塔积分，保证数值稳定性

#### 4. simulation.py - 仿真控制引擎

**主仿真循环**:
```python
while t <= max_time:
    # 1. 更新球拍运动
    # 2. 记录状态
    # 3. 检测事件 (网碰撞、桌碰撞、球拍碰撞)
    # 4. 积分球体运动
    # 5. 检查终止条件
```

**事件驱动机制**:
- **网穿越事件**: 成功/失败穿越检测
- **球桌反弹事件**: 记录反弹位置和物理
- **球拍击球事件**: 记录击球和选手交替
- **出界事件**: 球体离开有效区域

#### 5. racket_control.py - 球拍控制逻辑

**击球模式定义**:
- **flick**: 轻拉 (控制型击球)
- **topspin**: 上旋 (进攻型击球)
- **backspin**: 下旋 (防守型击球)
- **flat**: 平击 (快速击球)

**智能决策系统**:
```python
def should_player_hit(ball_pos, ball_vel, player, stroke):
    # 基于球位置、速度、击球参数判断是否击球
    # 考虑球拍反应时间和击球窗口
```

#### 6. scenarios.py - 场景配置管理

**预定义场景**:
- **serve**: 发球场景 (多种发球方式)
- **custom**: 自定义初始条件
- **trajectory**: 轨迹分析 (无球拍交互)

**参数化配置**:
- 位置、速度、角速度的灵活设置
- 击球序列的自定义配置

#### 7. visualization.py - 可视化引擎

**输出格式**:
- **CSV导出**: 轨迹数据 (位置、速度、事件)
- **3D可视化**: matplotlib 3D绘图
- **动画生成**: MP4/GIF 格式 (需要FFmpeg)

**可视化组件**:
- 球桌、球网的3D渲染
- 球拍位置和轨迹显示
- 事件标记 (反弹点、击球点)

## 物理模型详解

### 空气动力学

球体在空气中的运动遵循Navier-Stokes方程的简化形式：

```
m dv/dt = m g - 0.5 ρ v² S C_d v̂ + ρ R³ C_Ω (ω × v)
```

其中：
- **阻力项**: 与速度平方成正比
- **马格努斯力**: 旋转产生的升力，与角速度和速度的叉积成正比

### 碰撞模型

**球桌碰撞**:
- **法向恢复**: ε = 0.90 (ITTF标准)
- **切向摩擦**: μ = 0.25 (考虑滑动/粘着/过旋状态)

**球拍碰撞**:
- 不同胶皮类型具有不同的物理属性
- 支持复杂的旋转传递机制

### 乒乓球规则实现

系统完整实现了ITTF乒乓球规则：
- **发球规则**: 必须先在发球方桌面上反弹
- **得分规则**: 双反弹、网击、出界判断
- **回合转换**: 成功击球后交换发球权

## 技术特性

### 性能优化
- **自适应时间步长**: 根据运动剧烈程度调整计算精度
- **事件驱动**: 只在关键时刻进行详细计算
- **向量化计算**: 使用NumPy进行高效数值计算

### 可扩展性
- **模块化设计**: 易于添加新运动项目
- **参数化配置**: 支持不同球类和规则
- **插件架构**: 可扩展新的物理模型

### 数据完整性
- **轨迹记录**: 完整的位置、速度、角速度历史
- **事件日志**: 所有碰撞和规则事件的详细记录
- **元数据**: 仿真参数和环境条件的完整记录

## 质量保证

### 测试覆盖
- **单元测试**: 各模块独立功能测试
- **集成测试**: 完整仿真流程验证
- **物理验证**: 与解析解和实验数据对比

### 代码质量
- **类型提示**: 完整的类型注解
- **文档字符串**: 详细的函数和类文档
- **代码规范**: 遵循Google Python风格指南
